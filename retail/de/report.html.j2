<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Weekly Sales Briefing</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    .wrap { max-width: 960px; margin: 0 auto; background:#fff; }
    .header { background:#000; color:#fff; padding:20px 40px; display:flex; align-items:center; border-radius:8px 8px 0 0; }
    .logo { background:#ccc; color:#000; padding:7px 22px; margin-left:auto; }
    h2 { background:#ddd; padding:8px; margin:24px 0 8px; }
    table { border-collapse: collapse; width:100%; text-align:left; border:1px solid #ddd; font-size:13px; border-radius:8px; overflow:hidden; }
    th, td { border:1px solid #ddd; padding:6px 8px; }
    .section { padding:40px; }
    .footer { background:#000; color:#fff; text-align:center; font-size:12px; padding:10px 40px; border-radius:0 0 8px 8px; }
  </style>
</head>
<body>
  {# Fallback-Mapping, falls der Renderer 'kpi' nicht setzt #}
  {% if kpi is not defined and data is defined and data.kpi is defined %}
  {% set kpi = data.kpi %}
  {% elif kpi is not defined and data is defined %}
  {% set kpi = data %}
  {% elif kpi is not defined and ctx is defined and ctx.kpi is defined %}
  {% set kpi = ctx.kpi %}
  {% endif %}

  {% set week = kpi.week %}
  {% set mtd  = kpi.mtd  %}
  {% set ytd  = kpi.ytd  %}

  <div class="wrap header">
    <div style="font-size:28px; font-weight:bold;">
      Weekly Sales Briefing ‚Äì KW {{ week.SalesWeekNr }} - {{ week.SalesYear }}
    </div>
    <div class="logo">Logo</div>
  </div>

  <div class="wrap section">
    <h2>üìä √úbersicht Kennzahlen</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead style="background:#f2f2f2;">
          <tr>
            <th>Kennzahl</th><th>Woche</th><th>Woche PY</th><th>Œî</th><th>%</th>
            <th>MTD</th><th>MTD PY</th><th>Œî</th><th>%</th>
            <th>YTD</th><th>YTD PY</th><th>Œî</th><th>%</th>
          </tr>
        </thead>
        <tbody>
          {% macro row(label, w, m, y, base) -%}
            {% set wdiff = attribute(w, base ~ 'Diff') %}
            {% set mdiff = attribute(m, base ~ 'Diff') %}
            {% set ydiff = attribute(y, base ~ 'Diff') %}
            <tr>
              <td>{{ label }}</td>
              <td>{{ attribute(w, base) }}</td>
              <td>{{ attribute(w, base ~ 'PY') }}</td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ wdiff }}{{ ' ‚Üì' if (wdiff is number and wdiff < 0) else ' ‚Üë' if (wdiff is number and wdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ attribute(w, base ~ '_ChangePct') | default(None) | pct }}
              </td>

              <td>{{ attribute(m, base) }}</td>
              <td>{{ attribute(m, base ~ 'PY') }}</td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ mdiff }}{{ ' ‚Üì' if (mdiff is number and mdiff < 0) else ' ‚Üë' if (mdiff is number and mdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ attribute(m, base ~ '_ChangePct') | default(None) | pct }}
              </td>

              <td>{{ attribute(y, base) }}</td>
              <td>{{ attribute(y, base ~ 'PY') }}</td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ ydiff }}{{ ' ‚Üì' if (ydiff is number and ydiff < 0) else ' ‚Üë' if (ydiff is number and ydiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ attribute(y, base ~ '_ChangePct') | default(None) | pct }}
              </td>
            </tr>
          {%- endmacro %}

          {{ row('Netto Umsatz', week, mtd, ytd, 'NetAmount') }}
          {{ row('Transaktionen', week, mtd, ytd, 'TransactionCnt') }}
          {{ row('Kunden',        week, mtd, ytd, 'CustomerCnt') }}
          {{ row('Menge',         week, mtd, ytd, 'Quantity') }}
        </tbody>
      </table>
    </div>

    <h2>üìù Zusammenfassung</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>Woche:</strong> {{ llm.summaryWeek }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>MTD:</strong>   {{ llm.summaryMTD }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>YTD:</strong>   {{ llm.summaryYTD }}</p>

    <h2>üå§Ô∏è Wetter-Analyse</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ llm.weather }}</p>

    <h2>üì¶ Sortiment & Empfehlungen</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ llm.stock }}</p>
  </div>

  <div class="wrap footer">
    Dieses Briefing wurde automatisch erstellt. Bei Fragen wende dich an XXX.
  </div>
</body>
</html>
