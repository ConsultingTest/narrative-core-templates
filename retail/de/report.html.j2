<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <title>Weekly Sales Briefing</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    .wrap { max-width: 960px; margin: 0 auto; background:#fff; }
    .header { background:#000; color:#fff; padding:20px 40px; display:flex; align-items:center; border-radius:8px 8px 0 0; }
    .logo { background:#ccc; color:#000; padding:7px 22px; margin-left:auto; }
    h2 { background:#ddd; padding:8px; margin:24px 0 8px; }
    table { border-collapse: collapse; width:100%; text-align:left; border:1px solid #ddd; font-size:13px; border-radius:8px; overflow:hidden; }
    th, td { border:1px solid #ddd; padding:6px 8px; }
    .section { padding:40px; }
    .footer { background:#000; color:#fff; text-align:center; font-size:12px; padding:10px 40px; border-radius:0 0 8px 8px; }
  </style>
</head>
<body>
  {# --- Defensiver Zugriff auf Daten --- #}
  {% set week = (kpis.week | default({}, true)) %}
  {% set mtd  = (kpis.mtd  | default({}, true)) %}
  {% set ytd  = (kpis.ytd  | default({}, true)) %}

  <div class="wrap header">
    <div style="font-size:28px; font-weight:bold;">
      Weekly Sales Briefing ‚Äì KW {{ week.SalesWeekNr | default('‚Äì') }} - {{ week.SalesYear | default('‚Äì') }}
    </div>
    <div class="logo">Logo</div>
  </div>

  <div class="wrap section">
    <h2>üìä √úbersicht Kennzahlen</h2>
    <div style="overflow-x:auto;">
      <table>
        <thead style="background:#f2f2f2;">
          <tr>
            <th>Kennzahl</th><th>Woche</th><th>Woche PY</th><th>Œî</th><th>%</th>
            <th>MTD</th><th>MTD PY</th><th>Œî</th><th>%</th>
            <th>YTD</th><th>YTD PY</th><th>Œî</th><th>%</th>
          </tr>
        </thead>
        <tbody>
          {% macro row(label, w, m, y, base) -%}
            {% set wdiff = (w[base ~ 'Diff'] | default(None)) %}
            {% set mdiff = (m[base ~ 'Diff'] | default(None)) %}
            {% set ydiff = (y[base ~ 'Diff'] | default(None)) %}
            <tr>
              <td>{{ label }}</td>

              <td>{{ w[base] | default('') }}</td>
              <td>{{ w[base ~ 'PY'] | default('') }}</td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ wdiff | default('') }}{{ ' ‚Üì' if (wdiff is number and wdiff < 0) else ' ‚Üë' if (wdiff is number and wdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (wdiff is number and wdiff < 0) else 'green' if (wdiff is number and wdiff > 0) else 'inherit' }}">
                {{ (w[base ~ '_ChangePct'] | default(None)) | pct }}
              </td>

              <td>{{ m[base] | default('') }}</td>
              <td>{{ m[base ~ 'PY'] | default('') }}</td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ mdiff | default('') }}{{ ' ‚Üì' if (mdiff is number and mdiff < 0) else ' ‚Üë' if (mdiff is number and mdiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (mdiff is number and mdiff < 0) else 'green' if (mdiff is number and mdiff > 0) else 'inherit' }}">
                {{ (m[base ~ '_ChangePct'] | default(None)) | pct }}
              </td>

              <td>{{ y[base] | default('') }}</td>
              <td>{{ y[base ~ 'PY'] | default('') }}</td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ ydiff | default('') }}{{ ' ‚Üì' if (ydiff is number and ydiff < 0) else ' ‚Üë' if (ydiff is number and ydiff > 0) else '' }}
              </td>
              <td style="color: {{ 'red' if (ydiff is number and ydiff < 0) else 'green' if (ydiff is number and ydiff > 0) else 'inherit' }}">
                {{ (y[base ~ '_ChangePct'] | default(None)) | pct }}
              </td>
            </tr>
          {%- endmacro %}

          {{ row('Netto Umsatz', week, mtd, ytd, 'NetAmount') }}
          {{ row('Transaktionen', week, mtd, ytd, 'TransactionCnt') }}
          {{ row('Kunden',        week, mtd, ytd, 'CustomerCnt') }}
          {{ row('Menge',         week, mtd, ytd, 'Quantity') }}
        </tbody>
      </table>
    </div>

    <h2>üìù Zusammenfassung</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>Woche:</strong> {{ narrative.summaryWeek | default('') }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>MTD:</strong>   {{ narrative.summaryMTD | default('') }}</p>
    <p style="text-align:justify; line-height:1.6; font-size:16px;"><strong>YTD:</strong>   {{ narrative.summaryYTD | default('') }}</p>

    <h2>üå§Ô∏è Wetter-Analyse</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ narrative.weather | default('') }}</p>

    <h2>üì¶ Sortiment & Empfehlungen</h2>
    <p style="text-align:justify; line-height:1.6; font-size:16px;">{{ narrative.stock | default('') }}</p>
  </div>

  <div class="wrap footer">
    Dieses Briefing wurde automatisch erstellt. Bei Fragen wende dich an XXX.
  </div>
</body>
</html>
